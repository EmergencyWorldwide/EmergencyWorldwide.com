<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aussie Fire Chief Simulator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        .control-panel {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-9">
                <div id="map"></div>
            </div>
            <div class="col-md-3">
                <div class="control-panel">
                    <h3>Budget: $<span id="budget">0</span></h3>
                    <hr>
                    <h4>Build</h4>
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="setPlacementMode('fire_station')">Fire Station ($500,000)</button>
                    </div>
                    <hr>
                    <h4>Vehicles</h4>
                    <div class="mb-3">
                        <button class="btn btn-success" onclick="purchaseVehicle('fire_truck')">Fire Truck ($200,000)</button>
                    </div>
                    <hr>
                    <h4>Active Missions</h4>
                    <div id="missions-list" class="list-group">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let placementMode = null;
        let buildings = [];
        let missions = [];

        // Initialize map centered on Australia
        map = L.map('map').setView([-25.2744, 133.7751], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Load initial game state
        async function loadGameState() {
            const response = await fetch('/api/state');
            const data = await response.json();
            document.getElementById('budget').textContent = data.budget.toLocaleString();
        }

        // Load buildings
        async function loadBuildings() {
            const response = await fetch('/api/buildings');
            buildings = await response.json();
            buildings.forEach(building => {
                L.marker([building.lat, building.lon])
                    .bindPopup(`${building.type.replace('_', ' ').toUpperCase()}`)
                    .addTo(map);
            });
        }

        // Set placement mode
        function setPlacementMode(mode) {
            placementMode = mode;
            map.getContainer().style.cursor = 'crosshair';
        }

        // Handle map clicks for building placement
        map.on('click', async function(e) {
            if (!placementMode) return;

            const response = await fetch('/api/buildings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: placementMode,
                    lat: e.latlng.lat,
                    lon: e.latlng.lng,
                    cost: placementMode === 'fire_station' ? 500000 : 0
                })
            });

            const result = await response.json();
            if (result.success) {
                L.marker([e.latlng.lat, e.latlng.lng])
                    .bindPopup(placementMode.replace('_', ' ').toUpperCase())
                    .addTo(map);
                loadGameState();
            } else {
                alert('Insufficient funds!');
            }

            placementMode = null;
            map.getContainer().style.cursor = '';
        });

        // Purchase vehicle
        async function purchaseVehicle(type) {
            if (buildings.length === 0) {
                alert('Build a fire station first!');
                return;
            }

            const response = await fetch('/api/vehicles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: type,
                    building_id: buildings[0].id,
                    cost: 200000
                })
            });

            const result = await response.json();
            if (result.success) {
                loadGameState();
            } else {
                alert('Insufficient funds!');
            }
        }

        // Update missions
        async function updateMissions() {
            const response = await fetch('/api/missions');
            const newMissions = await response.json();
            
            // Remove old mission markers
            missions.forEach(mission => {
                if (mission.marker) {
                    mission.marker.remove();
                }
            });

            missions = newMissions;
            const missionsList = document.getElementById('missions-list');
            missionsList.innerHTML = '';

            missions.forEach(mission => {
                // Add marker
                const icon = L.divIcon({
                    className: 'mission-icon',
                    html: 'ðŸ”¥',
                    iconSize: [25, 25]
                });
                mission.marker = L.marker([mission.lat, mission.lon], {icon: icon}).addTo(map);

                // Add to list
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.textContent = `Fire at ${mission.lat.toFixed(4)}, ${mission.lon.toFixed(4)}`;
                missionsList.appendChild(item);
            });
        }

        // Initialize
        loadGameState();
        loadBuildings();
        setInterval(updateMissions, 5000);
    </script>
</body>
</html>

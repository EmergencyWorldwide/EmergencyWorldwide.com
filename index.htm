<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Worldwide</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #fff;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .menu button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            margin: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        .menu button:hover {
            background-color: #0056b3;
        }
        .menu button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .page-title {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .instructions {
            font-size: 1.2rem;
            color: #ddd;
            margin-bottom: 20px;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            background-color: #f44336;
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>

<div class="alert" id="alertBox">This location is already occupied by another building or vehicle.</div>

<!-- Main Page -->
<div id="main-page">
    <h1 class="page-title">üö® Emergency Worldwide</h1>
    <div class="instructions">Click on the map to place your buildings and vehicles. Follow the instructions below:</div>
    <div id="map"></div>
    <button class="menu" onclick="startPlacing('Fire Station')">üî• Place Fire Station</button>
    <button class="menu" onclick="startPlacing('Fire Engine')">üöí Place Fire Engine</button>
    <button class="menu" onclick="startPlacing('DMO Shed')">üîß Place DMO Shed</button>
</div>

<!-- Refund Page -->
<div id="refund-page" style="display: none;">
    <div>
        <h2 class="page-title">üí∞ Refund System</h2>
        <h3>Buildings</h3>
        <div id="refund-building-list" class="loading-spinner"></div>
        <h3>Vehicles</h3>
        <div id="refund-vehicle-list" class="loading-spinner"></div>
    </div>
    <button class="menu" onclick="showMainPage()">Back to Main</button>
</div>

<!-- View Details Page -->
<div id="view-details-page" style="display: none;">
    <h2 class="page-title">üìü View Details</h2>
    <div id="building-list" class="loading-spinner"></div>
    <div id="vehicle-list" class="loading-spinner"></div>
    <div id="mission-list" class="loading-spinner"></div>
    <button class="menu" onclick="showMainPage()">Back to Main</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    let balance = 1000000;
    let buildings = [];
    let vehicles = [];
    let markers = [];
    let placingType = null;

    let map = L.map('map').setView([-37.8136, 144.9631], 12);  
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function loadProgress() {
        let savedData = JSON.parse(localStorage.getItem('gameData'));
        if (savedData) {
            buildings = savedData.buildings || [];
            vehicles = savedData.vehicles || [];
            markers = savedData.markers || [];

            markers.forEach(markerData => {
                let marker = L.marker(markerData.data.location).addTo(map)
                    .bindPopup(markerData.data.name)
                    .on('click', function() {
                        viewDetails(this);
                    });
            });
        }
    }

    function updateLocalStorage() {
        let data = {
            buildings: buildings,
            vehicles: vehicles,
            markers: markers
        };
        localStorage.setItem('gameData', JSON.stringify(data));
    }

    function startPlacing(type) {
        placingType = type;
        alert(`Click on the map to place a ${type}.`);
    }

    map.on('click', function(event) {
        if (!placingType) return;

        let latlng = event.latlng;

        if (isDuplicateLocation(latlng)) {
            showAlert('This location is already occupied by another building or vehicle.');
            return;
        }

        let newMarker = L.marker(latlng).addTo(map)
            .bindPopup(`${placingType} - Click to view details`)
            .on('click', function() {
                viewDetails(this);
            });

        let markerData = {
            type: placingType,
            location: latlng,
            name: `${placingType} at ${latlng.lat.toFixed(3)}, ${latlng.lng.toFixed(3)}`
        };

        markers.push({ marker: newMarker, data: markerData });

        if (placingType === "Fire Engine") {
            vehicles.push(markerData);
        } else {
            buildings.push(markerData);
        }

        placingType = null;
        updateLocalStorage();
    });

    function isDuplicateLocation(latlng) {
        for (let markerData of markers) {
            let markerLocation = markerData.data.location;
            if (Math.abs(markerLocation.lat - latlng.lat) < 0.0001 && Math.abs(markerLocation.lng - latlng.lng) < 0.0001) {
                return true;
            }
        }
        return false;
    }

    function viewDetails(marker) {
        let markerData = markers.find(m => m.marker === marker);
        if (!markerData) return;

        let building = markerData.data;
        let vehicleList = vehicles.filter(v => v.location.lat === building.location.lat && v.location.lng === building.location.lng);

        let details = `
            <h3>${building.name} - Details</h3>
            <p>üìç Location: ${building.location.lat.toFixed(3)}, ${building.location.lng.toFixed(3)}</p>
            <h4>Assigned Vehicles:</h4>
            <ul>
                ${vehicleList.map(vehicle => `<li>${vehicle.name}</li>`).join('')}
            </ul>
            <button onclick="refundBuilding('${building.name}')">Refund (20%)</button>
        `;
        
        document.getElementById('building-list').innerHTML = details;
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('view-details-page').style.display = 'block';
    }

    function refundBuilding(buildingName) {
        let buildingIndex = buildings.findIndex(b => b.name === buildingName);
        let vehicleIndex = vehicles.findIndex(v => v.name === buildingName);

        if (buildingIndex !== -1) {
            let building = buildings[buildingIndex];
            let refundAmount = calculateRefund(building.type);
            buildings.splice(buildingIndex, 1);
            removeMarker(buildingName);
            alert(`You sold the ${building.name} for a refund of $${refundAmount.toFixed(2)}.`);
            balance += refundAmount;
        } else if (vehicleIndex !== -1) {
            let vehicle = vehicles[vehicleIndex];
            let refundAmount = calculateRefund(vehicle.type);
            vehicles.splice(vehicleIndex, 1);
            removeMarker(vehicle.name);
            alert(`You sold the ${vehicle.name} for a refund of $${refundAmount.toFixed(2)}.`);
            balance += refundAmount;
        }
        updateLocalStorage();
    }

    function removeMarker(name) {
        let markerToRemove = markers.find(m => m.data.name === name);
        if (markerToRemove) {
            map.removeLayer(markerToRemove.marker); 
            markers = markers.filter(m => m !== markerToRemove); 
        }
    }

    function calculateRefund(type) {
        let price = 0;
        if (type === 'Fire Engine') {
            price = 300000;
        } else if (type === 'Fire Station') {
            price = 500000;
        } else if (type === 'DMO Shed') {
            price = 100000;
        }
        return price * 0.20;
    }

    function showAlert(message) {
        let alertBox = document.getElementById('alertBox');
        alertBox.textContent = message;
        alertBox.style.display = 'block';
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 3000);
    }

    function showMainPage() {
        document.getElementById('view-details-page').style.display = 'none';
        document.getElementById('refund-page').style.display = 'none';
        document.getElementById('main-page').style.display = 'block';
    }

    function showRefundPage() {
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('view-details-page').style.display = 'none';
        document.getElementById('refund-page').style.display = 'block';
    }

    loadProgress();
</script>

</body>
</html>

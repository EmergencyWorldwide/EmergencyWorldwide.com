<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Worldwide</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Add your styling here */
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #fff;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .menu button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        .menu button:hover {
            background-color: #0056b3;
        }
        /* Add more styles as needed */
    </style>
</head>
<body>

<div class="menu">
    <button onclick="showMainPage()">🏠 Main Page</button>
    <button onclick="showRefundPage()">💰 Refund System</button>
    <button onclick="showViewDetailsPage()">🔍 View Details</button>
</div>

<!-- Main Page -->
<div id="main-page">
    <h1>🚨 Emergency Worldwide</h1>
    <div id="map"></div>
    <button onclick="startPlacing('Fire Station')">🔥 Place Fire Station</button>
    <button onclick="startPlacing('Fire Engine')">🚒 Place Fire Engine</button>
    <button onclick="startPlacing('DMO Shed')">🔧 Place DMO Shed</button>
</div>

<!-- Refund Page -->
<div id="refund-page" style="display: none;">
    <div>
        <h2>💰 Refund System</h2>
        <h3>Buildings</h3>
        <div id="refund-building-list">Loading buildings...</div>
        <h3>Vehicles</h3>
        <div id="refund-vehicle-list">Loading vehicles...</div>
    </div>
    <button onclick="showMainPage()">Back to Main</button>
</div>

<!-- View Details Page -->
<div id="view-details-page" style="display: none;">
    <h2>📟 View Details</h2>
    <div id="building-list">Loading buildings...</div>
    <div id="vehicle-list">Loading vehicles...</div>
    <div id="mission-list">Loading missions...</div>
    <button onclick="showMainPage()">Back to Main</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // Initial data storage
    let balance = 1000000;
    let buildings = [];
    let vehicles = [];
    let markers = [];
    let placingType = null;

    // Initialize the map
    let map = L.map('map').setView([-37.8136, 144.9631], 12);  
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Load progress from localStorage
    function loadProgress() {
        let savedData = JSON.parse(localStorage.getItem('gameData'));
        if (savedData) {
            buildings = savedData.buildings || [];
            vehicles = savedData.vehicles || [];
            markers = savedData.markers || [];

            markers.forEach(markerData => {
                let marker = L.marker(markerData.data.location).addTo(map)
                    .bindPopup(markerData.data.name)
                    .on('click', function() {
                        viewDetails(this);
                    });
            });
        }
    }

    // Save progress to localStorage
    function updateLocalStorage() {
        let data = {
            buildings: buildings,
            vehicles: vehicles,
            markers: markers
        };
        localStorage.setItem('gameData', JSON.stringify(data));
    }

    // Start placing a building or vehicle
    function startPlacing(type) {
        placingType = type;
        alert(`Click on the map to place a ${type}.`);
    }

    // Handle map click to place markers
    map.on('click', function(event) {
        if (!placingType) return;

        let latlng = event.latlng;
        let newMarker = L.marker(latlng).addTo(map)
            .bindPopup(`${placingType} - Click to view details`)
            .on('click', function() {
                viewDetails(this);
            });

        let markerData = {
            type: placingType,
            location: latlng,
            name: `${placingType} at ${latlng.lat.toFixed(3)}, ${latlng.lng.toFixed(3)}`
        };

        markers.push({ marker: newMarker, data: markerData });

        if (placingType === "Fire Engine") {
            vehicles.push(markerData);
        } else {
            buildings.push(markerData);
        }

        placingType = null;
        updateLocalStorage(); // Save progress after placing
    });

    // View details when clicking on a marker
    function viewDetails(marker) {
        let markerData = markers.find(m => m.marker === marker);
        if (!markerData) return;

        let building = markerData.data;
        let vehicleList = vehicles.filter(v => v.location.lat === building.location.lat && v.location.lng === building.location.lng);

        let details = `
            <h3>${building.name} - Details</h3>
            <p>📍 Location: ${building.location.lat.toFixed(3)}, ${building.location.lng.toFixed(3)}</p>
            <h4>Assigned Vehicles:</h4>
            <ul>
                ${vehicleList.map(vehicle => `<li>${vehicle.name}</li>`).join('')}
            </ul>
            <button onclick="refundBuilding('${building.name}')">Refund (20%)</button>
        `;
        
        document.getElementById('building-list').innerHTML = details;
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('view-details-page').style.display = 'block';
    }

    // Refund system: 20% refund when selling a building or vehicle
    function refundBuilding(buildingName) {
        let buildingIndex = buildings.findIndex(b => b.name === buildingName);
        let vehicleIndex = vehicles.findIndex(v => v.name === buildingName);

        if (buildingIndex !== -1) {
            let building = buildings[buildingIndex];
            let refundAmount = calculateRefund(building.type);
            buildings.splice(buildingIndex, 1);
            removeMarker(buildingName);
            alert(`You sold the ${building.name} for a refund of $${refundAmount.toFixed(2)}.`);
            balance += refundAmount;
        } else if (vehicleIndex !== -1) {
            let vehicle = vehicles[vehicleIndex];
            let refundAmount = calculateRefund(vehicle.type);
            vehicles.splice(vehicleIndex, 1);
            removeMarker(vehicle.name);
            alert(`You sold the ${vehicle.name} for a refund of $${refundAmount.toFixed(2)}.`);
            balance += refundAmount;
        }
        updateLocalStorage();
        updateRefundPage();
    }

    // Remove marker from the map
    function removeMarker(name) {
        let markerToRemove = markers.find(m => m.data.name === name);
        if (markerToRemove) {
            map.removeLayer(markerToRemove.marker); 
            markers = markers.filter(m => m !== markerToRemove); 
        }
    }

    // Calculate 20% refund
    function calculateRefund(type) {
        let price = 0;
        if (type === 'Fire Engine') {
            price = 300000;
        } else if (type === 'Fire Station') {
            price = 500000;
        } else if (type === 'DMO Shed') {
            price = 100000;
        }
        return price * 0.20;
    }

    // Update refund page with buildings and vehicles
    function updateRefundPage() {
        document.getElementById('refund-building-list').innerHTML = buildings.map(building => `<div>${building.name} - Refund: $${calculateRefund(building.type).toFixed(2)}</div>`).join('');
        document.getElementById('refund-vehicle-list').innerHTML = vehicles.map(vehicle => `<div>${vehicle.name} - Refund: $${calculateRefund(vehicle.type).toFixed(2)}</div>`).join('');
    }

    // Show the main page
    function showMainPage() {
        document.getElementById('view-details-page').style.display = 'none';
        document.getElementById('refund-page').style.display = 'none';
        document.getElementById('main-page').style.display = 'block';
    }

    // Show the refund page
    function showRefundPage() {
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('view-details-page').style.display = 'none';
        document.getElementById('refund-page').style.display = 'block';
    }

    // Initial page load
    loadProgress();
</script>

</body>
</html>
